<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de IPTU Careiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Adicionando Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary: #2c5aa0;
            --primary-dark: #1e3d72;
            --primary-light: #4a7fd4;
            --secondary: #f8f9fa;
            --accent: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --text: #333;
            --text-light: #6c757d;
            --border: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 30px;
        }
        
        .user-info i {
            font-size: 1.2rem;
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: var(--primary);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        td {
            padding: 15px;
        }
        
        .name-link {
            color: var(--primary);
            cursor: pointer;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .name-link:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            margin: 0 auto;
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 1200px;
            width: 100%;
            position: relative;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
            z-index: 10;
        }
        
        .close:hover {
            color: var(--danger);
        }
        
        .modal-details {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 30px;
        }
        
        .modal-column {
            flex: 1;
            min-width: 300px;
        }
        
        .modal-column h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .modal-column p {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .modal-column p strong {
            min-width: 180px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px 30px;
            border-top: 1px solid var(--border);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-edit {
            background-color: var(--warning);
            color: #212529;
        }
        
        .btn-edit:hover {
            background-color: #e0a800;
        }
        
        .btn-delete {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
        }
        
        .btn-save {
            background-color: var(--accent);
            color: white;
        }
        
        .btn-save:hover {
            background-color: #218838;
        }
        
        .btn-close {
            background-color: var(--secondary);
            color: var(--text);
        }
        
        .btn-close:hover {
            background-color: #e2e6ea;
        }
        
        form {
            padding: 30px;
        }
        
        form h2 {
            margin-bottom: 25px;
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        .calculated input {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        .error {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .stat-icon.primary {
            background: var(--primary);
        }
        
        .stat-icon.accent {
            background: var(--accent);
        }
        
        .stat-icon.warning {
            background: var(--warning);
        }
        
        .stat-info h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .modal-details {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">🏠</div>
                <div class="logo-text">
                    <h1>Gerenciamento de IPTU Careiro</h1>
                    <p>Sistema de Cadastro e Controle de IPTU</p>
                </div>
            </div>
            <div class="user-info">
                <i>👤</i>
                <span>Administrador</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon primary">📊</div>
                <div class="stat-info">
                    <h3 id="totalFichas">0</h3>
                    <p>Fichas Cadastradas</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon accent">💰</div>
                <div class="stat-info">
                    <h3 id="totalIPTU">R$ 0,00</h3>
                    <p>Total em IPTU</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning">📅</div>
                <div class="stat-info">
                    <h3 id="mesAtual">0</h3>
                    <p>Cadastros Este Mês</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Lista de Fichas Cadastradas</h2>
                <div>
                    <button class="btn btn-save" onclick="window.location.href='cadastro.html'">
                        <i>➕</i> Nova Ficha
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table id="fichasTable">
                    <thead>
                        <tr>
                            <th>Nome Completo</th>
                            <th>CPF/CNPJ</th>
                            <th>Valor do IPTU</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Fichas serão inseridas aqui via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes -->
    <div id="detalhesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('detalhesModal')">&times;</span>
            <div class="modal-details">
                <div class="modal-column" id="colunaContribuinte">
                    <h2>Dados do Contribuinte</h2>
                    <!-- Detalhes serão inseridos aqui -->
                </div>
                <div class="modal-column" id="colunaImovel">
                    <h2>Informações do Imóvel</h2>
                    <!-- Detalhes serão inseridos aqui -->
                </div>
                <div class="modal-column" id="colunaIPTU">
                    <h2>Cálculo do IPTU</h2>
                    <!-- Detalhes serão inseridos aqui -->
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-edit" id="btnEditar">
                    <i>✏️</i> Editar
                </button>
                <button class="btn btn-delete" id="btnEliminar">
                    <i>🗑️</i> Eliminar
                </button>
                <button class="btn btn-close" onclick="fecharModal('detalhesModal')">
                    <i>❌</i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para edição -->
    <div id="editarModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('editarModal')">&times;</span>
            <form id="editarForm">
                <h2>Editar Cadastro</h2>
                <div class="modal-details">
                    <div class="modal-column">
                        <h2>Dados do Contribuinte</h2>
                        <div class="form-group">
                            <label for="editNomeCompleto">Nome Completo:</label>
                            <input type="text" id="editNomeCompleto" class="uppercase" required>
                            <div id="editNomeCompletoError" class="error"></div>
                        </div>
                        <div class="form-group">
                            <label for="editCpfCnpj">CPF ou CNPJ:</label>
                            <input type="text" id="editCpfCnpj" maxlength="18" inputmode="numeric" required>
                            <div id="editCpfCnpjError" class="error"></div>
                        </div>
                        <div class="form-group">
                            <label for="editRg">RG:</label>
                            <input type="text" id="editRg" maxlength="10" inputmode="numeric" required>
                            <div id="editRgError" class="error"></div>
                        </div>
                        <div class="form-group">
                            <label for="editDataNascimento">Data de Nascimento:</label>
                            <input type="date" id="editDataNascimento" required>
                        </div>
                        <div class="form-group">
                            <label for="editRuaCorrespondencia">Rua Correspondência:</label>
                            <input type="text" id="editRuaCorrespondencia" class="uppercase">
                        </div>
                        <div class="form-group">
                            <label for="editNumeroCorrespondencia">Número Correspondência:</label>
                            <input type="text" id="editNumeroCorrespondencia" class="uppercase">
                        </div>
                        <div class="form-group">
                            <label for="editBairroCorrespondencia">Bairro Correspondência:</label>
                            <input type="text" id="editBairroCorrespondencia" class="uppercase">
                        </div>
                        <div class="form-group">
                            <label for="editTelefone">Telefone:</label>
                            <input type="tel" id="editTelefone" maxlength="15" required>
                            <div id="editTelefoneError" class="error"></div>
                        </div>
                        <div class="form-group">
                            <label for="editEmail">E-mail:</label>
                            <input type="email" id="editEmail" required>
                            <div id="editEmailError" class="error"></div>
                        </div>
                    </div>
                    <div class="modal-column">
                        <h2>Informações do Imóvel</h2>
                        <div class="form-group">
                            <label for="editRuaImovel">Rua Imóvel:</label>
                            <input type="text" id="editRuaImovel" class="uppercase" required>
                        </div>
                        <div class="form-group">
                            <label for="editNumeroImovel">Número Imóvel:</label>
                            <input type="text" id="editNumeroImovel" class="uppercase" required>
                        </div>
                        <div class="form-group">
                            <label for="editBairroImovel">Bairro Imóvel:</label>
                            <input type="text" id="editBairroImovel" class="uppercase" required>
                        </div>
                        <div class="form-group">
                            <label for="editCepImovel">CEP Imóvel:</label>
                            <input type="text" id="editCepImovel" maxlength="9" required>
                        </div>
                        <div class="form-group">
                            <label for="editMatriculaImovel">Matrícula do Imóvel:</label>
                            <input type="text" id="editMatriculaImovel" class="uppercase" required>
                        </div>
                        <div class="form-group">
                            <label for="editTipoImovel">Tipo de Imóvel:</label>
                            <select id="editTipoImovel" required>
                                <option value="">Selecione...</option>
                                <option value="Residencial">Residencial</option>
                                <option value="Comercial">Comercial</option>
                                <option value="Terreno">Terreno</option>
                                <option value="Misto">Misto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editAreaTerrenoCadastro">Área do Terreno (m²):</label>
                            <input type="number" id="editAreaTerrenoCadastro" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group">
                            <label for="editAreaConstruidaCadastro">Área Construída (m²):</label>
                            <input type="number" id="editAreaConstruidaCadastro" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group">
                            <label for="editNumeroPavimentos">Número de Pavimentos:</label>
                            <input type="number" id="editNumeroPavimentos" inputmode="numeric" required>
                        </div>
                        <div class="form-group">
                            <label for="editIdadeConstrucao">Idade da Construção (anos):</label>
                            <input type="number" id="editIdadeConstrucao" inputmode="numeric" required>
                        </div>
                        <div class="form-group">
                            <label for="editMaterialConstrucao">Material de Construção:</label>
                            <select id="editMaterialConstrucao" required>
                                <option value="">Selecione...</option>
                                <option value="Alvenaria">Alvenaria</option>
                                <option value="Madeira">Madeira</option>
                                <option value="Concreto">Concreto</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editCondicaoImovel">Condição do Imóvel:</label>
                            <select id="editCondicaoImovel" required>
                                <option value="">Selecione...</option>
                                <option value="Ocupado">Ocupado</option>
                                <option value="Desocupado">Desocupado</option>
                                <option value="Em Construção">Em Construção</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editBenfeitorias">Benfeitorias:</label>
                            <input type="text" id="editBenfeitorias" class="uppercase">
                        </div>
                        <div class="form-group">
                            <label for="editZoneamento">Zoneamento:</label>
                            <input type="text" id="editZoneamento" class="uppercase" required>
                        </div>
                    </div>
                    <div class="modal-column">
                        <h2>Cálculo do IPTU</h2>
                        <div class="form-group">
                            <label for="editAreaTerreno">Área do Terreno (m²):</label>
                            <input type="number" id="editAreaTerreno" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group">
                            <label for="editValorMqTerreno">Valor m² Terreno (R$):</label>
                            <input type="number" id="editValorMqTerreno" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group calculated">
                            <label>Valor do Terreno (VT):</label>
                            <input type="text" id="editValorTerreno" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editAreaConstruida">Área Construída (m²):</label>
                            <input type="number" id="editAreaConstruida" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group">
                            <label for="editValorMqConstrucao">Valor m² Construção (R$):</label>
                            <input type="number" id="editValorMqConstrucao" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group">
                            <label for="editFatorIdade">Fator Idade:</label>
                            <input type="number" id="editFatorIdade" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group">
                            <label for="editFatorPadrao">Fator Padrão:</label>
                            <input type="number" id="editFatorPadrao" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group calculated">
                            <label>Valor da Construção (VC):</label>
                            <input type="text" id="editValorConstrucao" readonly>
                        </div>
                        <div class="form-group calculated">
                            <label>Valor Venal (VV):</label>
                            <input type="text" id="editValorVenal" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editAliquota">Alíquota (%):</label>
                            <input type="number" id="editAliquota" step="0.01" inputmode="decimal" required>
                        </div>
                        <div class="form-group calculated">
                            <label>IPTU (R$):</label>
                            <input type="text" id="editIptu" readonly>
                        </div>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-save" onclick="salvarEdicao()">
                        <i>💾</i> Salvar Alterações
                    </button>
                    <button type="button" class="btn btn-close" onclick="fecharModal('editarModal')">
                        <i>❌</i> Fechar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCVW8YN4jRdRv5uYyPxWV_cZ8oS0a2I7hk",
            authDomain: "iptucareiro.firebaseapp.com",
            projectId: "iptucareiro",
            storageBucket: "iptucareiro.firebasestorage.app",
            messagingSenderId: "247099053843",
            appId: "1:247099053843:web:08717a5344fe36f00dece6"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Verificar autenticação do usuário
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // Se não estiver autenticado, redirecionar para login.html
                window.location.href = 'login.html';
            } else {
                // Se autenticado, carregar as fichas
                carregarFichas();
            }
        });

        let fichaAtualId = null;

        // Função para formatar valor em reais
        function formatarReais(valor) {
            if (typeof valor === 'string') {
                valor = parseFloat(valor.replace(/[^\d,]/g, '').replace(',', '.'));
            }
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Máscaras e validações
        function aplicarMascaras() {
            document.querySelectorAll('.uppercase').forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            });

            document.getElementById('editCpfCnpj').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                } else {
                    value = value.replace(/(\d{2})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1/$2');
                    value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
                }
                e.target.value = value;
            });

            document.getElementById('editCpfCnpj').addEventListener('blur', function() {
                const errorDiv = document.getElementById('editCpfCnpjError');
                const value = this.value.replace(/\D/g, '');
                if (value.length === 11) {
                    if (!validarCPF(this.value)) {
                        errorDiv.textContent = 'CPF inválido';
                    } else {
                        errorDiv.textContent = '';
                    }
                } else if (value.length === 14) {
                    if (!validarCNPJ(this.value)) {
                        errorDiv.textContent = 'CNPJ inválido';
                    } else {
                        errorDiv.textContent = '';
                    }
                } else {
                    errorDiv.textContent = 'CPF ou CNPJ inválido';
                }
            });

            document.getElementById('editRg').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 8) {
                    value = value.slice(0, 8) + '-' + value.slice(8, 9);
                }
                e.target.value = value.replace(/(\d{8})(\d)/, '$1-$2');
            });

            document.getElementById('editRg').addEventListener('blur', function() {
                const errorDiv = document.getElementById('editRgError');
                const rg = this.value;
                const rgRegex = /^\d{8}-\d{1}$/;
                if (!rgRegex.test(rg)) {
                    errorDiv.textContent = 'RG inválido (formato: 00000000-0)';
                } else {
                    errorDiv.textContent = '';
                }
            });

            document.getElementById('editTelefone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            });

            document.getElementById('editTelefone').addEventListener('blur', function() {
                const errorDiv = document.getElementById('editTelefoneError');
                const telefone = this.value.replace(/\D/g, '');
                if (telefone.length < 10 || telefone.length > 11) {
                    errorDiv.textContent = 'Telefone inválido';
                } else {
                    errorDiv.textContent = '';
                }
            });

            document.getElementById('editCepImovel').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 8) {
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            });

            document.getElementById('editEmail').addEventListener('blur', function() {
                const errorDiv = document.getElementById('editEmailError');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(this.value)) {
                    errorDiv.textContent = 'E-mail inválido';
                } else {
                    errorDiv.textContent = '';
                }
            });
        }

        // Função para validar CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) soma += parseInt(cpf.charAt(i-1)) * (11 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) soma += parseInt(cpf.charAt(i-1)) * (12 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            return resto === parseInt(cpf.charAt(10));
        }

        // Função para validar CNPJ
        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
                if (pos < 2) pos = 9;
            }
            let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
            if (resultado !== parseInt(digitos.charAt(0))) return false;
            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
                if (pos < 2) pos = 9;
            }
            resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
            return resultado === parseInt(digitos.charAt(1));
        }

        // Função para calcular IPTU
        function calcularEdicao() {
            const areaTerreno = parseFloat(document.getElementById('editAreaTerreno').value) || 0;
            const valorMqTerreno = parseFloat(document.getElementById('editValorMqTerreno').value) || 0;
            const areaConstruida = parseFloat(document.getElementById('editAreaConstruida').value) || 0;
            const valorMqConstrucao = parseFloat(document.getElementById('editValorMqConstrucao').value) || 0;
            const fatorIdade = parseFloat(document.getElementById('editFatorIdade').value) || 1;
            const fatorPadrao = parseFloat(document.getElementById('editFatorPadrao').value) || 1;
            const aliquota = parseFloat(document.getElementById('editAliquota').value) || 0;

            const vt = areaTerreno * valorMqTerreno;
            document.getElementById('editValorTerreno').value = formatarReais(vt);

            const vc = areaConstruida * valorMqConstrucao * fatorIdade * fatorPadrao;
            document.getElementById('editValorConstrucao').value = formatarReais(vc);

            const vv = vt + vc;
            document.getElementById('editValorVenal').value = formatarReais(vv);

            const iptuValor = (vv * aliquota) / 100;
            document.getElementById('editIptu').value = formatarReais(iptuValor);
        }

        // Carregar fichas
        async function carregarFichas() {
            const tableBody = document.querySelector('#fichasTable tbody');
            tableBody.innerHTML = '';

            try {
                const snapshot = await db.collection('IPTU').get();
                if (snapshot.empty) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3">
                                <div class="empty-state">
                                    <i>📋</i>
                                    <p>Nenhuma ficha cadastrada.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    atualizarEstatisticas(0, 0, 0);
                    return;
                }

                let totalFichas = 0;
                let totalIPTU = 0;
                let mesAtual = 0;
                const mesCorrente = new Date().getMonth();
                const anoCorrente = new Date().getFullYear();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalFichas++;
                    
                    // Calcular total de IPTU
                    if (data.iptu) {
                        const valor = parseFloat(data.iptu.replace(/[^\d,]/g, '').replace(',', '.'));
                        totalIPTU += valor;
                    }
                    
                    // Verificar se foi cadastrado no mês atual
                    if (data.dataCadastro) {
                        const dataCadastro = new Date(data.dataCadastro);
                        if (dataCadastro.getMonth() === mesCorrente && dataCadastro.getFullYear() === anoCorrente) {
                            mesAtual++;
                        }
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="name-link" data-id="${doc.id}">${data.nomeCompleto || 'N/A'}</span></td>
                        <td>${data.cpfCnpj || 'N/A'}</td>
                        <td>${data.iptu || 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });

                atualizarEstatisticas(totalFichas, totalIPTU, mesAtual);

                document.querySelectorAll('.name-link').forEach(link => {
                    link.addEventListener('click', async function() {
                        fichaAtualId = this.getAttribute('data-id');
                        const doc = await db.collection('IPTU').doc(fichaAtualId).get();
                        if (doc.exists) {
                            const data = doc.data();
                            preencherModalDetalhes(data);
                            document.getElementById('detalhesModal').style.display = 'block';
                        }
                    });
                });
            } catch (error) {
                console.error('Erro ao carregar fichas:', error);
                alert('Erro ao carregar fichas.');
            }
        }

        // Atualizar estatísticas
        function atualizarEstatisticas(totalFichas, totalIPTU, mesAtual) {
            document.getElementById('totalFichas').textContent = totalFichas;
            document.getElementById('totalIPTU').textContent = formatarReais(totalIPTU);
            document.getElementById('mesAtual').textContent = mesAtual;
        }

        // Preencher modal de detalhes
        function preencherModalDetalhes(data) {
            const colunaContribuinte = document.getElementById('colunaContribuinte');
            colunaContribuinte.innerHTML = '<h2>Dados do Contribuinte</h2>';
            colunaContribuinte.innerHTML += `<p><strong>Nome Completo:</strong> ${data.nomeCompleto || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>CPF/CNPJ:</strong> ${data.cpfCnpj || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>RG:</strong> ${data.rg || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>Data de Nascimento:</strong> ${data.dataNascimento || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>Rua Correspondência:</strong> ${data.ruaCorrespondencia || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>Número Correspondência:</strong> ${data.numeroCorrespondencia || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>Bairro Correspondência:</strong> ${data.bairroCorrespondencia || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>Telefone:</strong> ${data.telefone || 'N/A'}</p>`;
            colunaContribuinte.innerHTML += `<p><strong>E-mail:</strong> ${data.email || 'N/A'}</p>`;

            const colunaImovel = document.getElementById('colunaImovel');
            colunaImovel.innerHTML = '<h2>Informações do Imóvel</h2>';
            colunaImovel.innerHTML += `<p><strong>Rua Imóvel:</strong> ${data.ruaImovel || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Número Imóvel:</strong> ${data.numeroImovel || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Bairro Imóvel:</strong> ${data.bairroImovel || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>CEP Imóvel:</strong> ${data.cepImovel || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Matrícula do Imóvel:</strong> ${data.matriculaImovel || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Tipo de Imóvel:</strong> ${data.tipoImovel || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Área do Terreno (m²):</strong> ${data.areaTerrenoCadastro || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Área Construída (m²):</strong> ${data.areaConstruidaCadastro || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Número de Pavimentos:</strong> ${data.numeroPavimentos || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Idade da Construção (anos):</strong> ${data.idadeConstrucao || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Material de Construção:</strong> ${data.materialConstrucao || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Condição do Imóvel:</strong> ${data.condicaoImovel || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Benfeitorias:</strong> ${data.benfeitorias || 'N/A'}</p>`;
            colunaImovel.innerHTML += `<p><strong>Zoneamento:</strong> ${data.zoneamento || 'N/A'}</p>`;

            const colunaIPTU = document.getElementById('colunaIPTU');
            colunaIPTU.innerHTML = '<h2>Cálculo do IPTU</h2>';
            colunaIPTU.innerHTML += `<p><strong>Área do Terreno (m²):</strong> ${data.areaTerreno || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Valor m² Terreno (R$):</strong> ${data.valorMqTerreno || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Valor do Terreno:</strong> ${data.valorTerreno || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Área Construída (m²):</strong> ${data.areaConstruida || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Valor m² Construção (R$):</strong> ${data.valorMqConstrucao || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Fator Idade:</strong> ${data.fatorIdade || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Fator Padrão:</strong> ${data.fatorPadrao || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Valor da Construção:</strong> ${data.valorConstrucao || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Valor Venal:</strong> ${data.valorVenal || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Alíquota (%):</strong> ${data.aliquota || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>IPTU (R$):</strong> ${data.iptu || 'N/A'}</p>`;
            colunaIPTU.innerHTML += `<p><strong>Data de Cadastro:</strong> ${data.dataCadastro || 'N/A'}</p>`;
        }

        // Preencher modal de edição
        async function preencherModalEdicao() {
            const doc = await db.collection('IPTU').doc(fichaAtualId).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('editNomeCompleto').value = data.nomeCompleto || '';
                document.getElementById('editCpfCnpj').value = data.cpfCnpj || '';
                document.getElementById('editRg').value = data.rg || '';
                document.getElementById('editDataNascimento').value = data.dataNascimento || '';
                document.getElementById('editRuaCorrespondencia').value = data.ruaCorrespondencia || '';
                document.getElementById('editNumeroCorrespondencia').value = data.numeroCorrespondencia || '';
                document.getElementById('editBairroCorrespondencia').value = data.bairroCorrespondencia || '';
                document.getElementById('editTelefone').value = data.telefone || '';
                document.getElementById('editEmail').value = data.email || '';
                document.getElementById('editRuaImovel').value = data.ruaImovel || '';
                document.getElementById('editNumeroImovel').value = data.numeroImovel || '';
                document.getElementById('editBairroImovel').value = data.bairroImovel || '';
                document.getElementById('editCepImovel').value = data.cepImovel || '';
                document.getElementById('editMatriculaImovel').value = data.matriculaImovel || '';
                document.getElementById('editTipoImovel').value = data.tipoImovel || '';
                document.getElementById('editAreaTerrenoCadastro').value = data.areaTerrenoCadastro || '';
                document.getElementById('editAreaConstruidaCadastro').value = data.areaConstruidaCadastro || '';
                document.getElementById('editNumeroPavimentos').value = data.numeroPavimentos || '';
                document.getElementById('editIdadeConstrucao').value = data.idadeConstrucao || '';
                document.getElementById('editMaterialConstrucao').value = data.materialConstrucao || '';
                document.getElementById('editCondicaoImovel').value = data.condicaoImovel || '';
                document.getElementById('editBenfeitorias').value = data.benfeitorias || '';
                document.getElementById('editZoneamento').value = data.zoneamento || '';
                document.getElementById('editAreaTerreno').value = data.areaTerreno || '';
                document.getElementById('editValorMqTerreno').value = data.valorMqTerreno || '';
                document.getElementById('editAreaConstruida').value = data.areaConstruida || '';
                document.getElementById('editValorMqConstrucao').value = data.valorMqConstrucao || '';
                document.getElementById('editFatorIdade').value = data.fatorIdade || '';
                document.getElementById('editFatorPadrao').value = data.fatorPadrao || '';
                document.getElementById('editAliquota').value = data.aliquota || '';
                calcularEdicao();
            }
        }

        // Função para fechar modal
        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'editarModal') {
                document.getElementById('editarForm').reset();
                document.querySelectorAll('.error').forEach(error => error.textContent = '');
            }
        }

        // Função para salvar edição
        async function salvarEdicao() {
            const editarForm = document.getElementById('editarForm');
            const cpfCnpjError = document.getElementById('editCpfCnpjError').textContent;
            const rgError = document.getElementById('editRgError').textContent;
            const telefoneError = document.getElementById('editTelefoneError').textContent;
            const emailError = document.getElementById('editEmailError').textContent;

            if (!editarForm.checkValidity() || cpfCnpjError || rgError || telefoneError || emailError) {
                alert('Por favor, preencha todos os campos obrigatórios corretamente antes de salvar.');
                return;
            }

            const requiredFields = ['editAreaTerreno', 'editValorMqTerreno', 'editAreaConstruida', 'editValorMqConstrucao', 'editFatorIdade', 'editFatorPadrao', 'editAliquota'];
            const allFilled = requiredFields.every(field => document.getElementById(field).value.trim() !== '');
            if (!allFilled) {
                alert('Por favor, preencha todos os campos da calculadora antes de salvar.');
                return;
            }

            const ficha = {
                nomeCompleto: document.getElementById('editNomeCompleto').value,
                cpfCnpj: document.getElementById('editCpfCnpj').value,
                rg: document.getElementById('editRg').value,
                dataNascimento: document.getElementById('editDataNascimento').value,
                ruaCorrespondencia: document.getElementById('editRuaCorrespondencia').value,
                numeroCorrespondencia: document.getElementById('editNumeroCorrespondencia').value,
                bairroCorrespondencia: document.getElementById('editBairroCorrespondencia').value,
                telefone: document.getElementById('editTelefone').value,
                email: document.getElementById('editEmail').value,
                ruaImovel: document.getElementById('editRuaImovel').value,
                numeroImovel: document.getElementById('editNumeroImovel').value,
                bairroImovel: document.getElementById('editBairroImovel').value,
                cepImovel: document.getElementById('editCepImovel').value,
                matriculaImovel: document.getElementById('editMatriculaImovel').value,
                tipoImovel: document.getElementById('editTipoImovel').value,
                areaTerrenoCadastro: document.getElementById('editAreaTerrenoCadastro').value,
                areaConstruidaCadastro: document.getElementById('editAreaConstruidaCadastro').value,
                numeroPavimentos: document.getElementById('editNumeroPavimentos').value,
                idadeConstrucao: document.getElementById('editIdadeConstrucao').value,
                materialConstrucao: document.getElementById('editMaterialConstrucao').value,
                condicaoImovel: document.getElementById('editCondicaoImovel').value,
                benfeitorias: document.getElementById('editBenfeitorias').value,
                zoneamento: document.getElementById('editZoneamento').value,
                areaTerreno: document.getElementById('editAreaTerreno').value,
                valorMqTerreno: document.getElementById('editValorMqTerreno').value,
                valorTerreno: document.getElementById('editValorTerreno').value,
                areaConstruida: document.getElementById('editAreaConstruida').value,
                valorMqConstrucao: document.getElementById('editValorMqConstrucao').value,
                fatorIdade: document.getElementById('editFatorIdade').value,
                fatorPadrao: document.getElementById('editFatorPadrao').value,
                valorConstrucao: document.getElementById('editValorConstrucao').value,
                valorVenal: document.getElementById('editValorVenal').value,
                aliquota: document.getElementById('editAliquota').value,
                iptu: document.getElementById('editIptu').value,
                dataCadastro: new Date().toLocaleString('pt-BR')
            };

            try {
                await db.collection('IPTU').doc(fichaAtualId).update(ficha);
                alert('Ficha atualizada com sucesso!');
                fecharModal('editarModal');
                fecharModal('detalhesModal');
                carregarFichas();
            } catch (error) {
                console.error('Erro ao atualizar ficha:', error);
                alert('Erro ao atualizar a ficha. Verifique o console para mais detalhes.');
            }
        }

        // Evento para abrir modal de edição
        document.getElementById('btnEditar').addEventListener('click', function() {
            fecharModal('detalhesModal');
            preencherModalEdicao();
            document.getElementById('editarModal').style.display = 'block';
        });

        // Evento para eliminar
        document.getElementById('btnEliminar').addEventListener('click', async function() {
            if (confirm('Tem certeza que deseja eliminar esta ficha?')) {
                try {
                    await db.collection('IPTU').doc(fichaAtualId).delete();
                    alert('Ficha eliminada com sucesso!');
                    fecharModal('detalhesModal');
                    carregarFichas();
                } catch (error) {
                    console.error('Erro ao eliminar ficha:', error);
                    alert('Erro ao eliminar a ficha.');
                }
            }
        });

        // Evento para calcular IPTU ao editar
        document.querySelectorAll('#editarForm input:not([readonly])').forEach(input => {
            input.addEventListener('input', calcularEdicao);
        });

        // Inicializar máscaras
        aplicarMascaras();
    </script>
</body>
</html>